<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPO Živě - Linka 2</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; background: #121212; color: white; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        .overlay { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 20px; border: 1px solid red; pointer-events: none; text-align: center; min-width: 250px; }
    </style>
</head>
<body>
    <div class="overlay">
        <div style="font-weight: bold; color: #ff4d4d; margin-bottom: 5px;">Linka 2 Ostrava - Živě</div>
        <div id="status">Připojuji se...</div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([49.83, 18.27], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        let markers = [];

        async function nactiData() {
            const status = document.getElementById('status');
            // Použijeme RAW verzi, která ti právě v Network tabu hodila 200 OK
            const url = "https://api.allorigins.win/raw?url=" + encodeURIComponent("https://mapa.kodis.cz/api/vehicles");

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                // Vyfiltrujeme linku 2
                const vozy = data.vehicles.filter(v => v.route_short_name === "2");

                markers.forEach(m => map.removeLayer(m));
                markers = [];

                vozy.forEach(v => {
                    const icon = L.divIcon({
                        className: 'custom-icon',
                        html: `<div style="background: red; color: white; padding: 5px; border-radius: 50%; width: 20px; height: 20px; text-align: center; font-size: 10px; border: 2px solid white; font-weight: bold;">2</div>`
                    });

                    const m = L.marker([v.lat, v.lng], { icon: icon }).addTo(map)
                        .bindPopup(`<b>Vůz: ${v.vehicle_id}</b><br>Zpoždění: ${Math.round(v.delay/60)} min`);
                    markers.push(m);
                });

                status.innerText = `Aktualizováno: ${new Date().toLocaleTimeString()} (Vozy: ${vozy.length})`;
            } catch (e) {
                status.innerText = "Chyba načítání. Zkuste za moment.";
            }
        }

        setInterval(nactiData, 30000);
        nactiData();
    </script>
</body>
</html>
